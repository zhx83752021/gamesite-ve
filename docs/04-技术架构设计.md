# VR 游戏平台 - 技术架构设计

## 一、整体架构

### 1.1 系统架构图

```
┌───────────────────────────────────────────────────┐
│                   客户端层                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐          │
│  │ Web浏览器│  │  平板   │  │  手机   │          │
│  └────┬────┘  └────┬────┘  └────┬────┘          │
└───────┼───────────┼────────────┼────────────────┘
        │           │            │
        └───────────┴────────────┘
                    │
        ┌───────────▼────────────┐
        │   Vue3 + Vite + TS     │
        │  ┌──────────────────┐  │
        │  │ Pinia状态管理    │  │
        │  │ Vue Router路由   │  │
        │  │ Element Plus UI  │  │
        │  │ ECharts图表      │  │
        │  └──────────────────┘  │
        └───────────┬────────────┘
                    │ HTTP/WebSocket
        ┌───────────▼────────────┐
        │   Nginx反向代理         │
        │   负载均衡 + SSL        │
        └───────────┬────────────┘
                    │
        ┌───────────▼────────────┐
        │ Node.js + Express + TS │
        │  ┌──────────────────┐  │
        │  │ 用户服务         │  │
        │  │ 游戏服务         │  │
        │  │ 评论服务         │  │
        │  │ 搜索服务         │  │
        │  │ 文件服务         │  │
        │  └──────────────────┘  │
        └───────┬────────┬────────┘
                │        │
    ┌───────────▼──┐ ┌──▼─────────┐
    │ PostgreSQL   │ │   Redis    │
    │ 关系数据库   │ │   缓存     │
    └──────────────┘ └────────────┘
```

### 1.2 技术栈选型

#### 前端技术栈

| 技术         | 版本 | 用途        |
| ------------ | ---- | ----------- |
| Vue 3        | 3.4+ | 前端框架    |
| Vite         | 5.0+ | 构建工具    |
| TypeScript   | 5.3+ | 类型系统    |
| Pinia        | 2.1+ | 状态管理    |
| Vue Router   | 4.2+ | 路由管理    |
| Element Plus | 2.5+ | UI 组件库   |
| Axios        | 1.6+ | HTTP 客户端 |
| ECharts      | 5.4+ | 数据可视化  |
| TailwindCSS  | 3.4+ | CSS 框架    |

#### 后端技术栈

| 技术       | 版本   | 用途       |
| ---------- | ------ | ---------- |
| Node.js    | 20 LTS | 运行时环境 |
| Express    | 4.18+  | Web 框架   |
| TypeScript | 5.3+   | 类型系统   |
| TypeORM    | 0.3+   | ORM 框架   |
| PostgreSQL | 15+    | 关系数据库 |
| Redis      | 7.2+   | 缓存/队列  |
| JWT        | 9.0+   | 身份认证   |
| Socket.io  | 4.6+   | 实时通信   |

## 二、前端架构

### 2.1 项目结构

```
frontend/
├── public/                 # 静态资源
│   ├── favicon.ico
│   └── robots.txt
├── src/
│   ├── assets/            # 资源文件
│   │   ├── images/
│   │   ├── icons/
│   │   └── styles/
│   ├── components/        # 组件
│   │   ├── common/        # 通用组件
│   │   ├── layout/        # 布局组件
│   │   └── business/      # 业务组件
│   ├── views/             # 页面
│   │   ├── home/
│   │   ├── games/
│   │   ├── user/
│   │   ├── community/
│   │   └── admin/
│   ├── stores/            # 状态管理
│   │   ├── user.ts
│   │   ├── game.ts
│   │   └── app.ts
│   ├── router/            # 路由
│   │   ├── index.ts
│   │   └── routes.ts
│   ├── api/               # API接口
│   │   ├── user.ts
│   │   ├── game.ts
│   │   └── index.ts
│   ├── utils/             # 工具函数
│   │   ├── request.ts
│   │   ├── auth.ts
│   │   └── format.ts
│   ├── types/             # 类型定义
│   ├── composables/       # 组合式函数
│   ├── App.vue
│   └── main.ts
├── index.html
├── vite.config.ts
├── tsconfig.json
├── tailwind.config.js
└── package.json
```

### 2.2 状态管理（Pinia）

```typescript
// stores/user.ts
import { defineStore } from "pinia";

export const useUserStore = defineStore("user", {
  state: () => ({
    userInfo: null as User | null,
    token: localStorage.getItem("token") || "",
    isLoggedIn: false,
  }),

  getters: {
    userId: (state) => state.userInfo?.id,
    username: (state) => state.userInfo?.username,
    isAdmin: (state) => state.userInfo?.role === "admin",
  },

  actions: {
    async login(credentials: LoginForm) {
      const res = await api.auth.login(credentials);
      this.token = res.token;
      this.userInfo = res.user;
      this.isLoggedIn = true;
      localStorage.setItem("token", res.token);
    },

    async logout() {
      this.token = "";
      this.userInfo = null;
      this.isLoggedIn = false;
      localStorage.removeItem("token");
    },

    async fetchUserInfo() {
      const res = await api.user.getProfile();
      this.userInfo = res.data;
    },
  },
});
```

### 2.3 路由配置

```typescript
// router/routes.ts
import type { RouteRecordRaw } from "vue-router";

export const routes: RouteRecordRaw[] = [
  {
    path: "/",
    component: () => import("@/views/Layout.vue"),
    children: [
      {
        path: "",
        name: "Home",
        component: () => import("@/views/home/Index.vue"),
        meta: { title: "首页" },
      },
      {
        path: "games",
        name: "GameList",
        component: () => import("@/views/games/GameList.vue"),
        meta: { title: "游戏库" },
      },
      {
        path: "games/:id",
        name: "GameDetail",
        component: () => import("@/views/games/GameDetail.vue"),
        meta: { title: "游戏详情" },
      },
      {
        path: "user",
        component: () => import("@/views/user/Layout.vue"),
        meta: { requiresAuth: true },
        children: [
          {
            path: "profile",
            name: "UserProfile",
            component: () => import("@/views/user/Profile.vue"),
          },
          {
            path: "library",
            name: "UserLibrary",
            component: () => import("@/views/user/Library.vue"),
          },
        ],
      },
    ],
  },
  {
    path: "/admin",
    component: () => import("@/views/admin/Layout.vue"),
    meta: { requiresAuth: true, requiresAdmin: true },
    children: [
      {
        path: "dashboard",
        name: "AdminDashboard",
        component: () => import("@/views/admin/Dashboard.vue"),
      },
    ],
  },
];
```

### 2.4 API 封装

```typescript
// utils/request.ts
import axios from "axios";
import { useUserStore } from "@/stores/user";
import { ElMessage } from "element-plus";

const service = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000,
});

// 请求拦截器
service.interceptors.request.use(
  (config) => {
    const userStore = useUserStore();
    if (userStore.token) {
      config.headers.Authorization = `Bearer ${userStore.token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// 响应拦截器
service.interceptors.response.use(
  (response) => {
    const res = response.data;
    if (res.code !== 200) {
      ElMessage.error(res.message || "Error");
      return Promise.reject(new Error(res.message || "Error"));
    }
    return res;
  },
  (error) => {
    ElMessage.error(error.message || "请求失败");
    return Promise.reject(error);
  }
);

export default service;
```

## 三、后端架构

### 3.1 项目结构

```
backend/
├── src/
│   ├── config/            # 配置
│   │   ├── database.ts
│   │   ├── redis.ts
│   │   └── env.ts
│   ├── entities/          # 数据库实体
│   │   ├── User.ts
│   │   ├── Game.ts
│   │   ├── Comment.ts
│   │   └── Order.ts
│   ├── controllers/       # 控制器
│   │   ├── auth.controller.ts
│   │   ├── user.controller.ts
│   │   └── game.controller.ts
│   ├── services/          # 业务逻辑
│   │   ├── auth.service.ts
│   │   ├── user.service.ts
│   │   └── game.service.ts
│   ├── middlewares/       # 中间件
│   │   ├── auth.middleware.ts
│   │   ├── error.middleware.ts
│   │   └── logger.middleware.ts
│   ├── routes/            # 路由
│   │   ├── auth.routes.ts
│   │   ├── user.routes.ts
│   │   └── index.ts
│   ├── validators/        # 数据验证
│   │   └── user.validator.ts
│   ├── utils/             # 工具函数
│   │   ├── jwt.ts
│   │   └── logger.ts
│   ├── types/             # 类型定义
│   ├── app.ts             # Express应用
│   └── server.ts          # 服务器入口
├── tests/                 # 测试
├── .env
├── tsconfig.json
└── package.json
```

### 3.2 数据库连接（TypeORM）

```typescript
// config/database.ts
import { DataSource } from "typeorm";
import { User, Game, Comment, Order } from "../entities";

export const AppDataSource = new DataSource({
  type: "postgres",
  host: process.env.DB_HOST,
  port: Number(process.env.DB_PORT),
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  synchronize: process.env.NODE_ENV === "development",
  logging: process.env.NODE_ENV === "development",
  entities: [User, Game, Comment, Order],
  migrations: ["src/migrations/**/*.ts"],
  subscribers: [],
});
```

### 3.3 认证中间件

```typescript
// middlewares/auth.middleware.ts
import { Request, Response, NextFunction } from "express";
import jwt from "jsonwebtoken";

interface JwtPayload {
  userId: string;
  email: string;
  role: string;
}

export const authMiddleware = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    const token = req.headers.authorization?.split(" ")[1];

    if (!token) {
      return res.status(401).json({ message: "未提供认证令牌" });
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as JwtPayload;

    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ message: "令牌无效或已过期" });
  }
};

// 管理员权限检查
export const adminMiddleware = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  if (req.user?.role !== "admin") {
    return res.status(403).json({ message: "需要管理员权限" });
  }
  next();
};
```

### 3.4 错误处理中间件

```typescript
// middlewares/error.middleware.ts
import { Request, Response, NextFunction } from "express";
import { logger } from "../utils/logger";

export class AppError extends Error {
  statusCode: number;
  isOperational: boolean;

  constructor(message: string, statusCode: number) {
    super(message);
    this.statusCode = statusCode;
    this.isOperational = true;
    Error.captureStackTrace(this, this.constructor);
  }
}

export const errorHandler = (
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  let statusCode = 500;
  let message = "服务器内部错误";

  if (err instanceof AppError) {
    statusCode = err.statusCode;
    message = err.message;
  }

  logger.error({
    message: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
  });

  res.status(statusCode).json({
    code: statusCode,
    message,
    ...(process.env.NODE_ENV === "development" && { stack: err.stack }),
  });
};
```

## 四、数据库设计

### 4.1 Redis 缓存策略

```typescript
// config/redis.ts
import Redis from "ioredis";

export const redis = new Redis({
  host: process.env.REDIS_HOST,
  port: Number(process.env.REDIS_PORT),
  password: process.env.REDIS_PASSWORD,
  db: 0,
});

// 缓存键规范
export const CacheKeys = {
  // 游戏相关
  gameDetail: (id: string) => `game:${id}`,
  gameList: (page: number) => `games:page:${page}`,
  hotGames: () => "games:hot",

  // 用户相关
  userProfile: (id: string) => `user:${id}`,
  userGames: (id: string) => `user:${id}:games`,

  // 统计数据
  dailyStats: (date: string) => `stats:daily:${date}`,
  onlineUsers: () => "users:online",
};

// 缓存时间（秒）
export const CacheTTL = {
  gameDetail: 3600, // 1小时
  gameList: 600, // 10分钟
  hotGames: 300, // 5分钟
  userProfile: 1800, // 30分钟
  dailyStats: 86400, // 24小时
};
```

### 4.2 数据库索引优化

```typescript
// entities/Game.ts
import {
  Entity,
  PrimaryGeneratedColumn,
  Column,
  Index,
  CreateDateColumn,
} from "typeorm";

@Entity("games")
export class Game {
  @PrimaryGeneratedColumn("uuid")
  id: string;

  @Column({ length: 200 })
  @Index() // 标题索引
  title: string;

  @Column({ type: "decimal", precision: 10, scale: 2 })
  price: number;

  @Column({ type: "float", default: 0 })
  @Index() // 评分索引
  rating: number;

  @Column({ length: 50 })
  @Index() // 分类索引
  category: string;

  @Column({ default: 0 })
  @Index() // 下载量索引
  downloads: number;

  @CreateDateColumn()
  @Index() // 创建时间索引
  createdAt: Date;

  // 复合索引：分类+评分
  @Index(["category", "rating"])
  categoryRatingIndex?: string;
}
```

## 五、性能优化

### 5.1 前端优化

#### 代码分割

```typescript
// 路由懒加载
const routes = [
  {
    path: "/games",
    component: () =>
      import(/* webpackChunkName: "games" */ "@/views/games/GameList.vue"),
  },
];

// 组件懒加载
const HeavyComponent = defineAsyncComponent(
  () => import("./components/HeavyComponent.vue")
);
```

#### 图片优化

```vue
<template>
  <!-- 懒加载 -->
  <img v-lazy="imageUrl" alt="game cover" />

  <!-- 响应式图片 -->
  <picture>
    <source
      srcset="image-320w.webp"
      media="(max-width: 320px)"
      type="image/webp"
    />
    <source
      srcset="image-768w.webp"
      media="(max-width: 768px)"
      type="image/webp"
    />
    <img src="image-1920w.jpg" alt="game cover" />
  </picture>
</template>
```

#### 虚拟滚动

```typescript
import { useVirtualList } from "@vueuse/core";

const { list, containerProps, wrapperProps } = useVirtualList(gamesList, {
  itemHeight: 200,
  overscan: 5,
});
```

### 5.2 后端优化

#### 查询优化

```typescript
// 使用select减少字段
const games = await gameRepository.find({
  select: ["id", "title", "cover", "price", "rating"],
  where: { status: "published" },
});

// 预加载关联数据
const games = await gameRepository.find({
  relations: ["developer", "category"],
});

// 分页查询
const [games, total] = await gameRepository.findAndCount({
  skip: (page - 1) * pageSize,
  take: pageSize,
});
```

#### 缓存策略

```typescript
async getGameDetail(id: string): Promise<Game> {
  // 先查缓存
  const cached = await redis.get(CacheKeys.gameDetail(id));
  if (cached) {
    return JSON.parse(cached);
  }

  // 查数据库
  const game = await gameRepository.findOne({ where: { id } });

  // 写入缓存
  await redis.setex(
    CacheKeys.gameDetail(id),
    CacheTTL.gameDetail,
    JSON.stringify(game)
  );

  return game;
}
```

#### 限流

```typescript
import rateLimit from "express-rate-limit";

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100, // 限制100次请求
  message: "请求过于频繁，请稍后再试",
});

app.use("/api/", limiter);
```

## 六、安全措施

### 6.1 输入验证

```typescript
import { body, validationResult } from "express-validator";

export const registerValidator = [
  body("email").isEmail().normalizeEmail(),
  body("password")
    .isLength({ min: 8 })
    .matches(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])/),
  body("username").isLength({ min: 3, max: 20 }).isAlphanumeric(),

  (req: Request, res: Response, next: NextFunction) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    next();
  },
];
```

### 6.2 SQL 注入防护

```typescript
// TypeORM会自动参数化查询
const user = await userRepository.findOne({
  where: { email: userEmail }, // 安全
});

// 避免原始查询
// const user = await query(`SELECT * FROM users WHERE email = '${userEmail}'`);  // 危险！
```

### 6.3 XSS 防护

```typescript
import helmet from "helmet";
import xss from "xss";

app.use(helmet());

// 清理用户输入
const sanitize = (input: string): string => {
  return xss(input);
};
```

### 6.4 CSRF 防护

```typescript
import csrf from "csurf";

const csrfProtection = csrf({ cookie: true });
app.use(csrfProtection);
```

## 七、监控与日志

### 7.1 日志系统

```typescript
import winston from "winston";

export const logger = winston.createLogger({
  level: "info",
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: "error.log", level: "error" }),
    new winston.transports.File({ filename: "combined.log" }),
  ],
});

if (process.env.NODE_ENV !== "production") {
  logger.add(
    new winston.transports.Console({
      format: winston.format.simple(),
    })
  );
}
```

### 7.2 性能监控

```typescript
import responseTime from "response-time";

app.use(
  responseTime((req, res, time) => {
    logger.info({
      method: req.method,
      url: req.url,
      responseTime: `${time}ms`,
    });
  })
);
```

## 八、部署架构

### 8.1 Vercel 部署配置

```json
// vercel.json
{
  "version": 2,
  "builds": [
    {
      "src": "frontend/package.json",
      "use": "@vercel/static-build",
      "config": { "distDir": "dist" }
    },
    {
      "src": "backend/src/server.ts",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    { "src": "/api/(.*)", "dest": "/backend/src/server.ts" },
    { "src": "/(.*)", "dest": "/frontend/$1" }
  ]
}
```

### 8.2 环境变量配置

```bash
# .env.example
NODE_ENV=production

# 数据库
DB_HOST=your-db-host
DB_PORT=5432
DB_USER=your-db-user
DB_PASSWORD=your-db-password
DB_NAME=vr_game_platform

# Redis
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password

# JWT
JWT_SECRET=your-secret-key
JWT_REFRESH_SECRET=your-refresh-secret

# 前端URL
FRONTEND_URL=https://your-domain.com
```
