# VR 游戏平台 - 部署运维方案

## 一、部署架构

### 1.1 整体部署方案

```
┌─────────────────────────────────────────────┐
│            Vercel Edge Network              │
│         (全球CDN + 自动HTTPS)               │
└────────────┬────────────────────────────────┘
             │
    ┌────────┴────────┐
    │                 │
┌───▼─────────┐  ┌───▼──────────┐
│   前端部署   │  │  后端部署     │
│  (Vercel)   │  │  (Vercel     │
│             │  │  Serverless)  │
│  - Vue3     │  │  - Node.js    │
│  - 静态资源  │  │  - Express    │
└─────────────┘  └───┬───────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
   ┌────▼────┐  ┌───▼────┐  ┌───▼────┐
   │PostgreSQL│  │ Redis  │  │对象存储│
   │(Vercel  │  │(Upstash)│  │(Vercel │
   │Postgres)│  │        │  │ Blob)  │
   └─────────┘  └────────┘  └────────┘
```

### 1.2 技术选型理由

| 服务         | 方案              | 理由                               |
| ------------ | ----------------- | ---------------------------------- |
| **前端托管** | Vercel            | 免费、自动 CI/CD、全球 CDN         |
| **后端部署** | Vercel Serverless | 免费额度充足、自动扩展             |
| **数据库**   | Vercel Postgres   | 与 Vercel 集成、免费 5GB           |
| **缓存**     | Upstash Redis     | Serverless Redis、免费 10K 请求/天 |
| **文件存储** | Vercel Blob       | 与 Vercel 集成、免费 1GB           |
| **代码托管** | GitHub            | 免费、自动集成 Vercel              |

## 二、前端部署

### 2.1 项目配置

**vite.config.ts**:

```typescript
import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";
import path from "path";

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  build: {
    outDir: "dist",
    sourcemap: false,
    minify: "terser",
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
      },
    },
    rollupOptions: {
      output: {
        manualChunks: {
          "vue-vendor": ["vue", "vue-router", "pinia"],
          "element-plus": ["element-plus"],
          echarts: ["echarts"],
        },
      },
    },
  },
  server: {
    port: 3000,
    proxy: {
      "/api": {
        target: "http://localhost:5000",
        changeOrigin: true,
      },
    },
  },
});
```

### 2.2 环境变量配置

**.env.production**:

```bash
VITE_API_BASE_URL=https://your-domain.vercel.app/api
VITE_WS_URL=wss://your-domain.vercel.app/ws
VITE_CDN_URL=https://your-domain.vercel.app
```

### 2.3 Vercel 配置

**vercel.json**:

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "framework": "vite",
  "rewrites": [{ "source": "/(.*)", "destination": "/index.html" }],
  "headers": [
    {
      "source": "/assets/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, max-age=31536000, immutable"
        }
      ]
    }
  ]
}
```

### 2.4 构建脚本

**package.json**:

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix"
  }
}
```

## 三、后端部署

### 3.1 项目结构调整

```
backend/
├── api/                    # Vercel Serverless函数
│   ├── auth/
│   │   ├── login.ts
│   │   └── register.ts
│   ├── games/
│   │   ├── index.ts
│   │   └── [id].ts
│   └── users/
│       └── [id].ts
├── src/
│   ├── config/
│   ├── services/
│   ├── middleware/
│   └── utils/
├── vercel.json
└── package.json
```

### 3.2 Serverless 函数示例

**api/games/index.ts**:

```typescript
import { VercelRequest, VercelResponse } from "@vercel/node";
import { gameService } from "../../src/services/game.service";
import { authMiddleware } from "../../src/middleware/auth.middleware";

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // 设置CORS
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

  if (req.method === "OPTIONS") {
    return res.status(200).end();
  }

  try {
    if (req.method === "GET") {
      const games = await gameService.getGames(req.query);
      return res.status(200).json({
        code: 200,
        data: games,
      });
    }

    if (req.method === "POST") {
      // 需要认证
      const user = await authMiddleware(req);
      const game = await gameService.createGame(req.body, user.id);
      return res.status(201).json({
        code: 201,
        data: game,
      });
    }

    return res.status(405).json({ message: "Method not allowed" });
  } catch (error) {
    console.error(error);
    return res.status(500).json({
      code: 500,
      message: error.message,
    });
  }
}
```

### 3.3 Vercel 配置

**vercel.json**:

```json
{
  "version": 2,
  "builds": [
    {
      "src": "api/**/*.ts",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/api/$1"
    }
  ],
  "env": {
    "NODE_ENV": "production"
  }
}
```

### 3.4 环境变量配置

在 Vercel Dashboard 中配置：

```bash
# 数据库
DATABASE_URL=postgresql://...
POSTGRES_URL=postgresql://...

# Redis
REDIS_URL=redis://...
UPSTASH_REDIS_URL=redis://...

# JWT
JWT_SECRET=your-secret-key
JWT_REFRESH_SECRET=your-refresh-secret

# 文件存储
BLOB_READ_WRITE_TOKEN=vercel-blob-token
```

## 四、数据库部署

### 4.1 Vercel Postgres 配置

**创建数据库**:

```bash
# 在Vercel Dashboard中创建Postgres数据库
# 自动获得连接字符串
```

**数据库连接**:

```typescript
// src/config/database.ts
import { sql } from "@vercel/postgres";

export async function query(text: string, params?: any[]) {
  const result = await sql.query(text, params);
  return result;
}
```

### 4.2 数据库迁移

**初始化脚本** (scripts/init-db.ts):

```typescript
import { sql } from "@vercel/postgres";

async function initDatabase() {
  // 创建用户表
  await sql`
    CREATE TABLE IF NOT EXISTS users (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      username VARCHAR(50) UNIQUE NOT NULL,
      email VARCHAR(255) UNIQUE NOT NULL,
      password_hash VARCHAR(255) NOT NULL,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
  `;

  // 创建游戏表
  await sql`
    CREATE TABLE IF NOT EXISTS games (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      title VARCHAR(200) NOT NULL,
      developer_id UUID REFERENCES users(id),
      price DECIMAL(10, 2) DEFAULT 0,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
  `;

  console.log("Database initialized successfully");
}

initDatabase().catch(console.error);
```

**运行迁移**:

```bash
# 本地运行
npm run db:init

# 或使用Vercel CLI
vercel env pull
node scripts/init-db.js
```

### 4.3 数据库备份

```bash
# 备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump $DATABASE_URL > backup_$DATE.sql
```

## 五、Redis 缓存部署

### 5.1 Upstash Redis 配置

**连接配置**:

```typescript
// src/config/redis.ts
import { Redis } from "@upstash/redis";

export const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL!,
  token: process.env.UPSTASH_REDIS_TOKEN!,
});
```

**使用示例**:

```typescript
// 缓存游戏详情
async function getGameWithCache(id: string) {
  const cacheKey = `game:${id}`;

  // 先查缓存
  const cached = await redis.get(cacheKey);
  if (cached) {
    return JSON.parse(cached as string);
  }

  // 查数据库
  const game = await getGameFromDB(id);

  // 写入缓存（1小时）
  await redis.setex(cacheKey, 3600, JSON.stringify(game));

  return game;
}
```

## 六、文件存储部署

### 6.1 Vercel Blob 配置

```typescript
// src/utils/upload.ts
import { put } from "@vercel/blob";

export async function uploadImage(file: File): Promise<string> {
  const blob = await put(file.name, file, {
    access: "public",
    token: process.env.BLOB_READ_WRITE_TOKEN!,
  });

  return blob.url;
}
```

### 6.2 图片处理

```typescript
import sharp from "sharp";

export async function processImage(file: Buffer) {
  // 压缩图片
  const compressed = await sharp(file)
    .resize(1920, 1080, { fit: "inside" })
    .jpeg({ quality: 85 })
    .toBuffer();

  // 生成缩略图
  const thumbnail = await sharp(file)
    .resize(300, 200, { fit: "cover" })
    .jpeg({ quality: 80 })
    .toBuffer();

  return { compressed, thumbnail };
}
```

## 七、CI/CD 流程

### 7.1 GitHub Actions 配置

**.github/workflows/deploy.yml**:

```yaml
name: Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
```

### 7.2 自动化测试

**package.json**:

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  }
}
```

## 八、监控与日志

### 8.1 日志收集

**使用 Vercel Analytics**:

```typescript
// 在 main.ts 中添加
import { inject } from "@vercel/analytics";
inject();
```

### 8.2 错误追踪

**使用 Sentry**:

```typescript
// src/utils/sentry.ts
import * as Sentry from "@sentry/vue";

export function initSentry(app: App) {
  Sentry.init({
    app,
    dsn: process.env.VITE_SENTRY_DSN,
    environment: process.env.NODE_ENV,
    integrations: [new Sentry.BrowserTracing(), new Sentry.Replay()],
    tracesSampleRate: 1.0,
    replaysSessionSampleRate: 0.1,
    replaysOnErrorSampleRate: 1.0,
  });
}
```

### 8.3 性能监控

```typescript
// 监控API响应时间
export async function monitoredFetch(url: string, options?: RequestInit) {
  const start = Date.now();

  try {
    const response = await fetch(url, options);
    const duration = Date.now() - start;

    // 记录性能指标
    console.log(`API ${url} took ${duration}ms`);

    return response;
  } catch (error) {
    const duration = Date.now() - start;
    console.error(`API ${url} failed after ${duration}ms`, error);
    throw error;
  }
}
```

## 九、域名与 SSL

### 9.1 自定义域名配置

1. 在 Vercel Dashboard 中添加域名
2. 配置 DNS 记录：

```
A记录：76.76.21.21
CNAME：cname.vercel-dns.com
```

### 9.2 SSL 证书

Vercel 自动提供免费 SSL 证书（Let's Encrypt）

## 十、性能优化

### 10.1 CDN 配置

Vercel 自带全球 CDN，自动优化：

- 静态资源缓存
- Gzip/Brotli 压缩
- HTTP/2 推送
- 图片优化

### 10.2 缓存策略

```typescript
// Vercel Headers配置
export const config = {
  headers: [
    {
      source: "/api/games/:path*",
      headers: [
        {
          key: "Cache-Control",
          value: "s-maxage=300, stale-while-revalidate=600",
        },
      ],
    },
  ],
};
```

## 十一、成本估算

### 11.1 免费额度

| 服务              | 免费额度      | 说明            |
| ----------------- | ------------- | --------------- |
| Vercel Hosting    | 100GB 带宽/月 | 足够中小型应用  |
| Vercel Serverless | 100GB-Hrs/月  | 约 100 万次请求 |
| Vercel Postgres   | 5GB 存储      | 足够早期使用    |
| Upstash Redis     | 10K 请求/天   | 可升级到付费    |
| Vercel Blob       | 1GB 存储      | 可升级          |

### 11.2 扩展方案

当流量增长时：

1. **升级 Vercel Pro**：$20/月，更多额度
2. **独立数据库**：迁移到 AWS RDS 或阿里云
3. **CDN 加速**：使用 Cloudflare
4. **对象存储**：使用 AWS S3 或阿里云 OSS

## 十二、安全措施

### 12.1 环境变量管理

```bash
# 使用Vercel CLI管理
vercel env add DATABASE_URL
vercel env pull .env.local
```

### 12.2 API 限流

```typescript
import rateLimit from "express-rate-limit";

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
});

export default limiter;
```

### 12.3 CORS 配置

```typescript
const corsOptions = {
  origin: process.env.FRONTEND_URL,
  credentials: true,
  optionsSuccessStatus: 200,
};
```

## 十三、备份与恢复

### 13.1 数据备份策略

```bash
# 每日自动备份
0 2 * * * /usr/local/bin/backup-db.sh
```

### 13.2 恢复流程

```bash
# 从备份恢复
psql $DATABASE_URL < backup_20241202.sql
```

## 十四、部署检查清单

- [ ] 代码推送到 GitHub
- [ ] 环境变量配置完成
- [ ] 数据库初始化完成
- [ ] Redis 连接测试成功
- [ ] 文件上传功能测试
- [ ] API 接口测试通过
- [ ] 前端页面加载正常
- [ ] 移动端适配检查
- [ ] SSL 证书配置
- [ ] 自定义域名解析
- [ ] 监控和日志配置
- [ ] 备份策略启用
